---
// Testimonials data
const testimonials = [
	{
		name: "Mar√≠a Gonz√°lez",
		message: "Lorem ipsum dolor sit amet! üôè",
		avatar: null
	},
	{
		name: "Laura Mart√≠nez",
		message: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris.",
		avatar: null
	},
	{
		name: "Ana Rodr√≠guez",
		message: "Lorem ipsum dolor sit amet, consectetur adipiscing elit ‚ù§Ô∏è",
		avatar: null
	},
	{
		name: "Carmen L√≥pez",
		message: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.",
		avatar: null
	},
	{
		name: "Isabel Fern√°ndez",
		message: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor! üåü",
		avatar: null
	}
];
---

<div class="container mx-auto px-4 md:px-6">
	<h2 class="text-3xl md:text-4xl lg:text-5xl font-bold text-center mb-4 font-recoleta text-gray-900">
		Mensajes de amor de mis pacientes
	</h2>
	<p class="text-center text-gray-600 mb-4 max-w-2xl mx-auto">
		Testimonios reales de personas que han transformado su salud digestiva
	</p>
	
	<div class="max-w-2xl mx-auto">
		<div id="testimonials-container" class="relative overflow-hidden" style="height: 280px;">
			<!-- Gradient overlays for smooth fade effect -->
			<div class="absolute top-0 left-0 right-0 h-16 bg-linear-to-b from-white to-transparent pointer-events-none z-10"></div>
			<div class="absolute bottom-0 left-0 right-0 h-16 bg-linear-to-t from-white to-transparent pointer-events-none z-10"></div>
			
			<div id="testimonials-wrapper" class="space-y-4 transition-transform duration-700 ease-in-out pt-12 pb-16">
				{testimonials.map((testimonial, index) => (
					<div 
						class="testimonial-message"
						data-index={index}
					>
						<div class="flex items-start gap-3">
							<div class="shrink-0 w-10 h-10 rounded-full bg-linear-to-br from-pink-300 to-pink-400 flex items-center justify-center text-white shadow-md">
								{testimonial.avatar ? (
									<img src={testimonial.avatar} alt={testimonial.name} class="w-full h-full rounded-full object-cover" />
								) : (
									<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
									</svg>
								)}
							</div>
							<div class="flex-1">
								<div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-md border border-gray-100 relative">
									<div class="absolute -left-2 top-0 w-0 h-0 border-t-8 border-t-white border-r-8 border-r-transparent"></div>
								<p class="text-sm font-semibold text-gray-900 mb-1">{testimonial.name}</p>
								<p class="text-gray-700 text-sm leading-relaxed">{testimonial.message}</p>
								<div class="flex justify-end items-center gap-1 mt-2">
									<span class="text-xs text-gray-400">Ahora</span>
									<svg class="w-4 h-4 text-blue-500 read-ticks opacity-0 transition-opacity duration-300" viewBox="0 0 16 15" fill="none" xmlns="http://www.w3.org/2000/svg">
										<path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.879a.32.32 0 0 1-.484.033l-.358-.325a.319.319 0 0 0-.484.032l-.378.483a.418.418 0 0 0 .036.541l1.32 1.266c.143.14.361.125.484-.033l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.879a.32.32 0 0 1-.484.033L1.891 7.769a.366.366 0 0 0-.515.006l-.423.433a.364.364 0 0 0 .006.514l3.258 3.185c.143.14.361.125.484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z" fill="currentColor"/>
									</svg>
								</div>
								</div>
							</div>
						</div>
					</div>
				))}
			</div>
		</div>
	</div>
</div>

<script>
	const wrapper = document.getElementById('testimonials-wrapper');
	const messages = document.querySelectorAll('.testimonial-message');
	const container = document.getElementById('testimonials-container');
	
	if (wrapper && messages.length > 0 && container) {
		const ROTATION_INTERVAL = 4000; // 4 seconds between rotations
		let currentIndex = 0;
		let isAnimating = false;
		let intervalId: number | null = null;
		
		// Clone messages for seamless infinite scroll
		messages.forEach((message) => {
			const clone = message.cloneNode(true) as HTMLElement;
			wrapper.appendChild(clone);
		});
		
		function showReadTicks(index: number) {
			// Show ticks for the current top message
			const allMessages = wrapper?.querySelectorAll('.testimonial-message');
			if (!allMessages) return;
			
			// Hide all ticks first
			allMessages.forEach((msg) => {
				const ticks = msg.querySelector('.read-ticks');
				if (ticks) {
					ticks.classList.remove('opacity-100');
					ticks.classList.add('opacity-0');
				}
			});
			
			// Show ticks for the current top message
			const currentMessage = allMessages[index];
			if (currentMessage) {
				const ticks = currentMessage.querySelector('.read-ticks');
				if (ticks) {
					// Delay to simulate WhatsApp read receipt
					setTimeout(() => {
						ticks.classList.remove('opacity-0');
						ticks.classList.add('opacity-100');
					}, 400);
				}
			}
		}
		
		function rotateMessages() {
			if (isAnimating || !wrapper) return;
			isAnimating = true;
			
			currentIndex++;
			
			// Calculate the offset by summing up actual heights of previous messages
			const gap = 16; // space-y-4 = 1rem = 16px
			let offset = 0;
			
			for (let i = 0; i < currentIndex; i++) {
				const message = wrapper.children[i] as HTMLElement;
				offset += message.offsetHeight + gap;
			}
			
			wrapper.style.transform = `translateY(-${offset}px)`;
			
			// When we've scrolled past half the messages, reset without animation
			if (currentIndex >= messages.length) {
				setTimeout(() => {
					if (!wrapper) return;
					wrapper.style.transition = 'none';
					currentIndex = 0;
					wrapper.style.transform = 'translateY(0)';
					
					// Re-enable transition after a frame
					requestAnimationFrame(() => {
						if (!wrapper) return;
						wrapper.style.transition = 'transform 0.7s ease-in-out';
						isAnimating = false;
						showReadTicks(currentIndex);
					});
				}, 700); // Wait for animation to complete
			} else {
				setTimeout(() => {
					isAnimating = false;
					showReadTicks(currentIndex);
				}, 700);
			}
		}
		
		// Show ticks on first message initially
		showReadTicks(0);
		
		// Intersection Observer to start/stop animation when visible
		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						// Start rotation
						if (!intervalId) {
							intervalId = window.setInterval(rotateMessages, ROTATION_INTERVAL);
						}
					} else {
						// Stop rotation when not visible
						if (intervalId) {
							clearInterval(intervalId);
							intervalId = null;
						}
					}
				});
			},
			{
				threshold: 0.2,
				rootMargin: '0px'
			}
		);
		
		observer.observe(container);
	}
</script>

