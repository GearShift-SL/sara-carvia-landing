---
import type { ImageMetadata } from 'astro';
import { SEO } from 'astro-seo';

import { SITE } from '@/config';
import Header from '@/components/Header.astro';

import '@/styles/global.css';

import importImage from '@/utils/importImage';

// Accept metadata props that can be passed from blog posts
export interface Props {
  metadata?: {
    title?: string;
    useTitleTemplate?: boolean;
    description?: string;
    ogImagePath?: string;
    canonicalUrl?: string;
    pubDatetime?: Date;
    modDatetime?: Date;
    author?: string;
    index?: boolean;
    follow?: boolean;
  };
}

const { metadata } = Astro.props;

// Import the ogImage dynamically if it's provided
let ogImage: ImageMetadata | undefined;
if (metadata?.ogImagePath) {
  ogImage = await importImage(metadata?.ogImagePath);
} else {
  ogImage = await importImage(SITE.ogImage);
}
---

<!doctype html>
<html lang={SITE.locale} dir="ltr">
  <head>
    <!-- Common Metadata -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="sitemap" href="/sitemap-index.xml" />
    
    <!-- Tabler Flags -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.4.0/dist/css/tabler-flags.min.css" />

    {
      import.meta.env.PROD && SITE.umamiWebsiteId && (
        <script defer src={`https://umami.hlab.es/${SITE.umamiWebsiteId}`} data-website-id={SITE.umamiWebsiteId} />
      )
    }

    <!-- Favicons -->
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content={SITE.title} />
    <link rel="manifest" href="/favicon/site.webmanifest" />

    <!-- SEO stuff -->
    <!-- Uses SITE config by default -->
    <SEO
      title={metadata?.title || SITE.title}
      titleTemplate={metadata?.useTitleTemplate ? `%s - ${SITE.title}` : undefined}
      description={metadata?.description || SITE.description}
      canonical={metadata?.canonicalUrl || Astro.url.href}
      noindex={metadata?.index === false}
      nofollow={metadata?.follow === false}
      openGraph={{
        basic: {
          title: metadata?.title || SITE.title,
          type: 'website',
          image: ogImage?.src,
          url: metadata?.canonicalUrl || Astro.url.href,
        },
        article: {
          authors: metadata?.author || SITE.author ? [metadata?.author || SITE.author] : undefined,
          publishedTime: metadata?.pubDatetime ? new Date(metadata.pubDatetime).toISOString() : undefined,
          modifiedTime: metadata?.modDatetime ? new Date(metadata.modDatetime).toISOString() : undefined,
        },
        optional: {
          locale: SITE.locale,
          siteName: SITE.title,
          description: metadata?.description || SITE.description,
        },
      }}
      twitter={{
        card: 'summary_large_image',
        site: SITE.twitter.site,
        title: metadata?.title || SITE.title,
        description: metadata?.description || SITE.description,
        image: ogImage?.src,
      }}
    />

    <!-- Google Site Verification -->
    {SITE.googleSiteVerificationId && <meta name="google-site-verification" content={SITE.googleSiteVerificationId} />}

  </head>
  <body class="bg-page text-default transition ease duration-300">
    <slot />
  </body>
</html>
